
# Perforation, 1 à 5 trous

Évaluer si le Nombre de feuilles perforées **comptant 1 à 5 trous**, diffèrent significativement selon la méthode de contrôle appliquée.

Jeu de données `kam.csv` qui contient différentes mesures dont les nombres de feuilles perforées **portant 1 à 5 trous**, comptés en 4 séances.

On pourrait également évaluer si les différentes méthodes ont des intensités d'attaques de ce type, significativement différentes avec le temps. On comparera les effets des méthodes séance par séance, puis à l'aide d'une figure on appréciera s'il y a une évolution en fonction du temps.


```{r message=FALSE, warning=FALSE, echo=FALSE}
library("ggpubr")
library("agricolae")
library("car")
library("rstatix")
library("Rmisc")
library("tidyverse")
library("emmeans")
```

## Les données

```{r message = FALSE, warning = FALSE}
df <- read_csv("data/kam.csv")
df <- df %>% 
  mutate(id = rep(1:8, 4), .before = 1, seance = factor(seance),
         methode = factor(methode, levels = c("Temoin", "Filet-anti-insectes", "Lutte-mecanique", "Cigogne-50-EC")), 
         bloc = factor(bloc)) %>% 
  select(id, seance, bloc, methode, nt15) %>% 
  mutate(id = factor(id))
```

Le tableau est déjà structuré en format long en Excel. J'ai ajouté un identifiant (`id`) pour les échantillons des seances.

Afficher quelques lignes aléatoires par methode pour visualiser le dataframe :

```{r message = FALSE, warning = FALSE}
set.seed(144)
df %>% sample_n_by(seance, methode, size = 1)
```


## Visualisation boxplots

```{r fp15.-boxplot}
bxp <- ggplot(df, aes(x = methode, y = nt15, fill = methode)) +
  geom_boxplot() +
  facet_grid(seance ~ .) +
  ylab("Nombre de feuilles avec 1 à 5 trous") +
  #theme(axis.text.x = element_text(angle = 45, color = "black", vjust = 1, hjust = 1)) +
  theme_bw()
bxp
```

Il y a des variations notables entre les méthodes et également d'une seance à l'autre.

## Détection des observations aberrantes extrêmes

```{r}
df_out <- df %>%
  group_by(seance, methode) %>%
  identify_outliers(nt15)
df_out
```

=> Pas d'observation aberrante extrême pour toutes les seances.


## L'ANOVA

### Séance 1 (1ère semaine de mesure)

#### Le modèle

```{r}
df1 <- df %>% filter(seance == "Semaine 1")

lm1 <- glm(nt15 ~ methode, data = df1, family = poisson)
Anova(lm1)
```

La p-value < 0.05 => différence très significative entre les effets des méthodes de contrôle sur le Nombre de feuilles avec 1 à 5 trous à la Semaine 1.


#### Comparaisons par paires

```{r}
pwc_lm1 = emmeans(lm1, ~ methode)
(cm1 <- pairs(pwc_lm1) %>% as_tibble() %>% 
    mutate(no_contrast = c("Contraste 1", "Contraste 2", "Contraste 3", "Contraste 4", "Contraste 5", "Contraste 6")))
```

=> Différence pour le **contraste 2** entre le Témoin et la lutte mécanique.

```{r fp15.1-pwc}
plot(pairs(pwc_lm1))
```

```{r}
(cm1_moy <- summarySE(df1, 
                     measurevar = "nt15", 
                     groupvars = "methode") %>% 
   data.table::setorder(-nt15))
```

```{r}
(cm1_moy <- cm1_moy %>% mutate(groups = c("a", "ab", "ab", "b")))
```

=> Du moment où cette méthode ici est faite à la main, très facile de se tromper. Toujours se référer à la figure et au tableau des contrastes.

Sous forme graphique ...

```{r fp15.1-barplot}
ggplot(data = cm1_moy, mapping = aes(x = methode, y = nt15)) +
  geom_bar(stat = "identity", color = "blue", fill = "grey", width = 0.5) +
  #geom_errorbar(aes(ymin = nt15 - ci, ymax = nt15 + ci), width =.1) +
  geom_text(aes(label = groups), vjust = -0.5, size = 4) +
  #ylim(0, 13) +
  xlab("Méthodes") + ylab("Nombre de feuilles avec 1 à 5 trous") +
  #theme(axis.text.x = element_text(angle = 45, color = "black", vjust = 1, hjust = 1)) +
  theme_bw()
```


### Séance 2 (2è semaine de mesure)

#### Le modèle

```{r}
df2 <- df %>% filter(seance == "Semaine 2")

(df2_out <- df2 %>%
  identify_outliers(nt15))
```


```{r}
lm2 <- glm(nt15 ~ methode, data = df2, family = poisson)
Anova(lm2)
```

La p-value < 0.05 => différence très significative entre les effets des méthodes de contrôle sur le Nombre de feuilles avec 1 à 5 trous à la Semaine 2.


#### Comparaisons par paires

```{r}
pwc_lm2 = emmeans::emmeans(lm2, ~ methode)
(cm2 <- pairs(pwc_lm2) %>% as_tibble() %>% 
    mutate(no_contrast = c("Contraste 1", "Contraste 2", "Contraste 3", "Contraste 4", "Contraste 5", "Contraste 6")))
```

Cette classification établie une différence significative entre les effets pour le contraste 6, la lutte mécanique contre l'insecticide.

```{r fp15.2-pwc}
plot(pairs(pwc_lm2))
```

Moyennes et cart-types et ajout d'une colonne à la main pour constituer les groupes.

```{r}
(cm2_moy <- summarySE(df2, 
                     measurevar = "nt15", 
                     groupvars = "methode") %>% 
   data.table::setorder(-nt15))
```

```{r}
(cm2_moy <- cm2_moy %>% mutate(groups = c("a", "ab", "ab", "b")))
```

Sous forme graphique ...

```{r fp15.2-barplot}
ggplot(data = cm2_moy, mapping = aes(x = methode, y = nt15)) +
  geom_bar(stat = "identity", color = "blue", fill = "grey", width = 0.5) +
  #geom_errorbar(aes(ymin = nt15 - ci, ymax = nt15 + ci), width =.1) +
  geom_text(aes(label = groups), vjust = -0.5, size = 4) +
  #ylim(0, 13) +
  xlab("Méthodes") + ylab("Nombre de feuilles avec 1 à 5 trous") +
  #theme(axis.text.x = element_text(angle = 45, color = "black", vjust = 1, hjust = 1)) +
  theme_bw()
```


### Séance 3 (3è semaine de mesure)

#### Le modèle

```{r}
df3 <- df %>% filter(seance == "Semaine 3")

(df3_out <- df3 %>%
  identify_outliers(nt15))
```

=> Pas d'observation supposée extrême.

```{r}
lm3 <- glm(nt15 ~ methode, data = df3, family = poisson)
Anova(lm3)
```

La p-value < 0.05 => différence très significative entre les effets des méthodes de contrôle sur le Nombre de feuilles avec 1 à 5 trous à la Semaine 3.


#### Comparaisons par paires

```{r}
pwc_lm3 = emmeans(lm3, ~ methode)
(cm3 <- pairs(pwc_lm3) %>% as_tibble() %>% 
    mutate(no_contrast = c("Contraste 1", "Contraste 2", "Contraste 3", "Contraste 4", "Contraste 5", "Contraste 6")))
```

Cette classification établie une différence significative entre les effets du filet et le Témoin (contrastes 1).

```{r fp15.3-pwc}
plot(pairs(pwc_lm3))
```

Moyennes et cart-type et ajout d'une colonne à la main pour constituer les groupes.

```{r}
(cm3_moy <- summarySE(df3, 
                     measurevar = "nt15", 
                     groupvars = "methode") %>% 
   data.table::setorder(-nt15))
```

```{r}
(cm3_moy <- cm3_moy %>% mutate(groups = c("a", "ab", "ab", "b")))
```

Sous forme graphique ...

```{r fp15.3-barplot}
ggplot(data = cm3_moy, mapping = aes(x = methode, y = nt15)) +
  geom_bar(stat = "identity", color = "blue", fill = "grey", width = 0.5) +
  #geom_errorbar(aes(ymin = nt15 - ci, ymax = nt15 + ci), width =.1) +
  geom_text(aes(label = groups), vjust = -0.5, size = 4) +
  #ylim(0, 13) +
  xlab("Méthodes") + ylab("Nombre de feuilles avec 1 à 5 trous") +
  #theme(axis.text.x = element_text(angle = 45, color = "black", vjust = 1, hjust = 1)) +
  theme_bw()
```



### Séance 4 (4è semaine de mesure)

#### Le modèle

```{r}
df4 <- df %>% filter(seance == "Semaine 4")

(df4_out <- df4 %>%
  identify_outliers(nt15))
```

=> Pas d'observation supposée aberrante.

```{r}
lm4 <- glm(nt15 ~ methode, data = df4, family = poisson)
Anova(lm4)
```

La p-value > 0.05 => pas de différence significative entre les effets des méthodes de contrôle sur le Nombre de feuilles avec 1 à 5 trous à la Semaine 4.


#### Comparaisons par paires

```{r}
pwc_lm4 = emmeans(lm4, ~ methode)
(cm4 <- pairs(pwc_lm4) %>% as_tibble() %>% 
    mutate(no_contrast = c("Contraste 1", "Contraste 2", "Contraste 3", "Contraste 4", "Contraste 5", "Contraste 6")))
```

Pas de différence significative pour tous les contrastes. 

```{r}
plot(pairs(pwc_lm4))
```

Moyennes et cart-type et ajout d'une colonne à la main pour constituer les groupes (ici on attribue la même lettre).

```{r}
(cm4_moy <- summarySE(df4, 
                     measurevar = "nt15", 
                     groupvars = "methode") %>% 
   data.table::setorder(-nt15))
```

```{r}
(cm4_moy <- cm4_moy %>% mutate(groups = c("a", "a", "a", "a")))
```

Sous forme graphique ...

```{r fp15.4-barplot}
ggplot(data = cm4_moy, mapping = aes(x = methode, y = nt15)) +
  geom_bar(stat = "identity", color = "blue", fill = "grey", width = 0.5) +
  #geom_errorbar(aes(ymin = nt15 - ci, ymax = nt15 + ci), width =.1) +
  geom_text(aes(label = groups), vjust = -0.5, size = 4) +
  #ylim(0, 13) +
  xlab("Méthodes") + ylab("Nombre de feuilles avec 1 à 5 trous") +
  #theme(axis.text.x = element_text(angle = 45, color = "black", vjust = 1, hjust = 1)) +
  theme_bw()
```



## Évolution du Nombre de feuilles avec 1 à 5 trous selon la méthode au cours du temps

### Sommaire

```{r}
df_ic <- summarySE(df, 
                   measurevar = "nt15", 
                   groupvars = c("seance", "methode"),
                   na.rm = TRUE)

df_ic
```


### Visualisation

```{r fp15.-temps-evo}
ggplot(df_ic, aes(x = seance, y = nt15, colour = methode, group = methode)) + 
  geom_line(size = 1) +
  geom_point(size = 2) +
  ylab("Nombre de feuilles avec 1 à 5 trous") +
  theme_bw()
```

Tendance difficile à exploiter.

Nous savons par les analyses pour chaque seance plus haut, que

- Semaine 1 : différences d'effet
- Semaine 2 : différences d'effet
- Semaine 3 : différences d'effet
- Semaine 4 : pas de différences d'effet


Puisque les données ne répondent pas aux conditions pour évaluer les effets des méthodes au cours du temps, on négligera l'effet des méthodes pour évaluer globalement l'effet du temps.

> **On pourrait se demander si les nombres de feuilles perforées portant 1 à 5 trous, comptées sur l'ensemble des méthodes, sont significativement différents d'une seance à l'autre (c'est-à-dire avec le temps)**.

### Effet du temps

#### boxplots, facteur temps

```{r fp15.-temps-boxplot}
bxp <- ggplot(df, aes(x = seance, y = nt15)) +
  geom_boxplot()
bxp
```

#### Valeurs aberrantes, facteur temps

```{r}
df <- df %>% mutate(id2 = 1:nrow(.), .before = 1)
df_out <- df %>%
  group_by(seance) %>%
  identify_outliers(nt15) %>% 
  select(id2, seance, bloc, methode, is.outlier, is.extreme)
df_out
```

Une observation témoin est classée aberrante pour la Semaine 1. Pas exclue.

```{r}
#df <- df %>% filter(id2 != ...)
```


#### Homogénéité des variances et ANOVA, facteur temps

Les autres conditions ont déjà été vérifiées.

```{r message = FALSE, warning = FALSE}
lm <- anova_test(data = df,
                 dv = nt15,        # dependant variable, num
                 wid = id,        # identificateur de cas/échantillon (facteur)
                 within = seance) # facteur de groupement intra-sujets

get_anova_table(lm)
```

=> Celui là dit pas de différence d'une semaine à l'autre.

#### Comparaisons par paires, facteur temps

```{r}
lmo <- lm(nt15 ~ seance, data = df)
pwc_lmo = emmeans::emmeans(lmo, ~ seance)
(cmo <- pairs(pwc_lmo) %>% as_tibble() %>% 
    mutate(no_contrast = c("Contraste 1", "Contraste 2", "Contraste 3", "Contraste 4", "Contraste 5", "Contraste 6")))
```

=> Lui aussi, pas de différence.

```{r}
tph <- df %>%
  pairwise_t_test(nt15 ~ seance, 
                  paired = TRUE,
                  p.adjust.method = "bonferroni")

tph %>% 
  select(group1, group2, p, p.adj, p.adj.signif)
```

=> C'est la p-value qui nous intéresse et elle est > 0.05 pour tous les contrates. Pour une fois les 2 précédents codes ont des sorties identiques !

#### Boxplots avec p-values

```{r fp15.-temps-pwc, message = FALSE, warning = FALSE}
tph <- tph %>% add_xy_position(x = "seance")

ggboxplot(df, x = "seance", y = "nt15") + 
  stat_pvalue_manual(tph) +
  labs(subtitle = get_test_label(lm, detailed = TRUE), 
       caption = get_pwc_label(tph))
```




